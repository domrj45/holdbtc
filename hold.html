<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hold BTC - DCA Tracker</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #0e0e0e;
    color: #f0f0f0;
    margin: 0;
    padding: 0;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #1a1a1a;
    padding: 15px 25px;
    border-bottom: 2px solid #f7931a;
    flex-wrap: wrap;
    gap: 10px;
  }

  h1 {
    color: #f7931a;
    margin: 0;
    font-size: 1.4rem;
    flex: 1;
  }

  .file-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .file-controls p {
    font-size: 0.8rem;
    color: #ccc;
    margin: 0;
    max-width: 250px;
  }

  .file-controls button {
    background: #f7931a;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
  }

  .file-controls button:hover {
    background: #d37c0c;
  }

  .file-controls input {
    color: #ccc;
    font-size: 0.8rem;
  }

  .container {
    padding: 20px;
  }

  .form-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  input, button {
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
  }

  input {
    width: 180px;
    background: #222;
    color: #fff;
  }

  button#addBtn {
    background: #f7931a;
    color: #fff;
    cursor: pointer;
  }

  button#addBtn:hover {
    background: #d37c0c;
  }

  .table-container {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #1a1a1a;
    border-radius: 10px;
    overflow: hidden;
    min-width: 600px;
  }

  th, td {
    padding: 12px;
    text-align: center;
    border-bottom: 1px solid #333;
  }

  th {
    background: #262626;
    color: #f7931a;
  }

  .actions button {
    background: none;
    color: #f7931a;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }

  .summary {
    display: flex;
    justify-content: space-around;
    align-items: center;
    flex-wrap: wrap;
    background: #1b1b1b;
    border: 1px solid #2c2c2c;
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
    gap: 10px;
  }

  .summary-item {
    text-align: center;
    flex: 1 1 20px;
  }

  .calc-sats {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    background: #1b1b1b;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #2c2c2c;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .calc-sats input {
    width: 150px;
  }

  .calc-sats span {
    font-size: 0.9rem;
    color: #f7931a;
    font-weight: bold;
  }

  .profit { color: #4CAF50; font-weight: bold; }
  .loss { color: #ff5252; font-weight: bold; }

  p { word-wrap: break-word; font-size: 0.85rem; color: #bbb; }

  @media (max-width: 768px) {
    .calc-sats { flex-direction: column; text-align: center; }
    .calc-sats input { width: 100%; }
  }
</style>
</head>
<body>

<header>
  <h1>Hold BTC Tracker</h1>
  <div class="file-controls">
    <p>Você precisa sempre carregar e salvar o arquivo com o DCA.</p>
    <button id="saveXmlBtn"><i class="fa fa-save"></i> Salvar XML</button>
    <input type="file" id="loadXmlInput" accept=".xml">
  </div>
</header>

<div class="container">

  <div class="summary" id="resumo">
    <div class="summary-item" id="investido"><b>Total Investido:</b>R$ 0,00</div>
    <div class="summary-item" id="btcTotal"><b>Total em BTC:</b>0 sats</div>
    <div class="summary-item" id="precoMedio"><b>Preço médio:</b>R$ 0,00 / sat</div>
    <div class="summary-item" id="cotacoes"><b>Cotações:</b>BTC/USD: ... | USD/BRL: ...</div>
    <div class="summary-item" id="lucroTotal"><b>Lucro/Prejuízo total:</b>R$ 0,00 (0%)</div>
  </div>

  <!-- CALCULADORA DE SATS -->
  <div class="calc-sats">
    <input type="number" id="brlInput" placeholder="Valor em BRL">
    <input type="number" id="taxaInput" placeholder="Taxa P2P (%)">
    <button id="calcBtn">Calcular Sats</button>
    <span id="resultadoSats">Receberá aproximadamente: 0 sats</span>
  </div>
    <br>
    <div class="form-container">
    <input type="number" id="valorBRL" placeholder="Valor DCA (BRL)">
    <input type="number" id="sats" placeholder="Satoshis recebidos">
    <button id="addBtn">Adicionar</button>
  </div>

  <br>

  <div class="table-container">
    <table id="tabela">
      <thead>
        <tr>
          <th>Investimento (BRL)</th>
          <th>BTC Adquirido (sats)</th>
          <th>Data</th>
          <th>Cotação USD/BTC</th>
          <th>Lucro/Prejuízo</th>
          <th>Editar</th>
          <th>Excluir</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <br>
  <p>Uma esmola para esse mendigo: <br>
  Lightning: weedyhubcap01@walletofsatoshi.com <br>
  Liquid: VJLB5zEzKMMTLtoepMcDsY8e6Pin8SttMoQhqmyjsUk9qZTuNfuv2JUuiYSiNpHiswecWKLEKkcBd7vK</p>
</div>

<script>
let dados = [];
let cotacaoBTC = 0;
let cotacaoUSD = 0;

async function atualizarCotacoes() {
  try {
    const [btcRes, usdRes] = await Promise.all([
      fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT'),
      fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL')
    ]);
    const btcData = await btcRes.json();
    const usdData = await usdRes.json();
    cotacaoBTC = parseFloat(btcData.price);
    cotacaoUSD = parseFloat(usdData.USDBRL.bid);
    document.getElementById("cotacoes").innerHTML =
      `<b>Cotações:</b><br>BTC/USD: $${cotacaoBTC.toFixed(2)} | USD/BRL: R$ ${cotacaoUSD.toFixed(2)}`;
    renderizarTabela();
  } catch (e) {
    document.getElementById("cotacoes").innerHTML = `<b>Cotações:</b><br>Erro ao carregar`;
  }
}
atualizarCotacoes();

// --- Calculadora de Sats ---
document.getElementById("calcBtn").addEventListener("click", () => {
  const brl = parseFloat(document.getElementById("brlInput").value);
  const taxa = parseFloat(document.getElementById("taxaInput").value) || 0;
  if (!brl || cotacaoBTC === 0 || cotacaoUSD === 0) {
    return alert("Preencha o valor e aguarde a cotação carregar.");
  }

  const valorLiquido = brl * (1 - taxa / 100);
  const btc = valorLiquido / (cotacaoBTC * cotacaoUSD);
  const sats = btc * 100000000;
  document.getElementById("resultadoSats").innerHTML = `Receberá: ${sats.toFixed(0)} sats`;
});

function renderizarTabela() {
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  dados.forEach((item, i) => {
    const valorAtual = (item.sats / 100000000) * cotacaoBTC * cotacaoUSD;
    const lucro = valorAtual - item.valor;
    const porcentagem = ((lucro / item.valor) * 100).toFixed(2);
    const lucroClass = lucro >= 0 ? "profit" : "loss";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td contenteditable="true" onblur="editarCampo(${i}, 'valor', this.innerText)">${item.valor.toFixed(2)}</td>
      <td contenteditable="true" onblur="editarCampo(${i}, 'sats', this.innerText)">${item.sats}</td>
      <td>${item.data}</td>
      <td>$${item.cotacao}</td>
      <td class="${lucroClass}">R$ ${lucro.toFixed(2)} (${porcentagem}%)</td>
      <td class="actions"><button><i class="fa fa-pen"></i></button></td>
      <td class="actions"><button onclick="removerEntrada(${i})"><i class="fa fa-trash"></i></button></td>
    `;
    tbody.appendChild(tr);
  });
  atualizarResumo();
}

function editarCampo(index, campo, valor) {
  valor = valor.replace(',', '.').replace(/[^\d.-]/g, '');
  if (campo === 'valor') dados[index].valor = parseFloat(valor) || 0;
  if (campo === 'sats') dados[index].sats = parseFloat(valor) || 0;
  renderizarTabela();
}

function atualizarResumo() {
  const totalInvestido = dados.reduce((sum, d) => sum + d.valor, 0);
  const totalSats = dados.reduce((sum, d) => sum + d.sats, 0);
  const precoMedio = totalSats > 0 ? totalInvestido / totalSats : 0;
  const valorAtualTotal = (totalSats / 100000000) * cotacaoBTC * cotacaoUSD;
  const lucroTotal = valorAtualTotal - totalInvestido;
  const lucroPercent = totalInvestido > 0 ? (lucroTotal / totalInvestido) * 100 : 0;
  const lucroClass = lucroTotal >= 0 ? "profit" : "loss";
  document.getElementById("investido").innerHTML = `<b>Total Investido:</b><br>R$ ${totalInvestido.toFixed(2)}`;
  document.getElementById("btcTotal").innerHTML = `<b>Total em BTC:</b><br>${totalSats} sats`;
  document.getElementById("precoMedio").innerHTML = `<b>Preço médio:</b><br>R$ ${precoMedio.toFixed(8)} / sat`;
  document.getElementById("lucroTotal").innerHTML =
    `<b>Lucro/Prejuízo total:</b><br><span class="${lucroClass}">R$ ${lucroTotal.toFixed(2)} (${lucroPercent.toFixed(2)}%)</span>`;
}

document.getElementById("addBtn").addEventListener("click", () => {
  const valor = parseFloat(document.getElementById("valorBRL").value);
  const sats = parseFloat(document.getElementById("sats").value);
  if (!valor || !sats) return alert("Preencha os dois campos corretamente.");
  const data = new Date().toLocaleDateString("pt-BR");
  const cotacao = cotacaoBTC;
  dados.push({ valor, sats, data, cotacao });
  renderizarTabela();
});

function removerEntrada(i) {
  dados.splice(i, 1);
  renderizarTabela();
}

document.getElementById("saveXmlBtn").addEventListener("click", () => {
  let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<hold>\n`;
  dados.forEach(d => {
    xml += `  <entrada>\n`;
    xml += `    <valor>${d.valor}</valor>\n`;
    xml += `    <sats>${d.sats}</sats>\n`;
    xml += `    <data>${d.data}</data>\n`;
    xml += `    <cotacao>${d.cotacao}</cotacao>\n`;
    xml += `  </entrada>\n`;
  });
  xml += `</hold>`;
  const blob = new Blob([xml], { type: "application/xml" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "hold-btc.xml";
  link.click();
});

document.getElementById("loadXmlInput").addEventListener("change", function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(e.target.result, "application/xml");
    const entradas = xml.getElementsByTagName("entrada");
    dados = [];
    for (let i = 0; i < entradas.length; i++) {
      const valor = parseFloat(entradas[i].getElementsByTagName("valor")[0].textContent);
      const sats = parseFloat(entradas[i].getElementsByTagName("sats")[0].textContent);
      const data = entradas[i].getElementsByTagName("data")[0].textContent;
      const cotacao = parseFloat(entradas[i].getElementsByTagName("cotacao")[0].textContent);
      dados.push({ valor, sats, data, cotacao });
    }
    renderizarTabela();
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
